<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant Management Dashboard - Movonte</title>
    <link rel="stylesheet" href="ceo-dashboard.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .global-assistant-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .global-assistant-info .info-label {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .global-assistant-info .info-value {
            font-size: 16px;
            font-weight: 600;
        }

        .status-disable-config-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .status-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .status-checkbox {
            margin-right: 8px;
        }

        .status-label {
            font-size: 14px;
            cursor: pointer;
        }

        /* Header Logo Styles */
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 6px;
        }

        .header-title h1 {
            margin: 0;
        }

        /* Header Actions Styles */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none; /* Oculto por defecto, se muestra solo para admins */
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #666;
            font-size: 14px;
        }

        .user-role {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .user-role.admin {
            background: #fff3e0;
            color: #f57c00;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }

        /* User Management Table */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .users-table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .users-table tr:hover {
            background: #f9fafb;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        /* Permissions Modal Styles */
        .permissions-info {
            margin-bottom: 24px;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .permissions-description {
            margin: 8px 0 0 0;
            color: #6b7280;
            font-size: 14px;
        }

        .permissions-grid {
            display: grid;
            gap: 16px;
        }

        .permission-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s ease;
        }

        .permission-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .permission-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
            margin: 0;
        }

        .permission-checkbox {
            margin-top: 2px;
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .permission-text {
            flex: 1;
        }

        .permission-text strong {
            display: block;
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .permission-text small {
            color: #6b7280;
            font-size: 13px;
            line-height: 1.4;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-admin {
            background: #fff3e0;
            color: #f57c00;
        }

        .role-user {
            background: #e3f2fd;
            color: #1976d2;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn.active {
            background: #f3f4f6;
            color: #374151;
            border-bottom: 2px solid #3b82f6;
        }

        .tab-btn:hover:not(.active) {
            background: #f9fafb;
            color: #374151;
        }

        .settings-tab-content {
            min-height: 200px;
        }

        .settings-tab-content h3 {
            margin: 0 0 16px 0;
            color: #1f2937;
            font-size: 18px;
        }

        /* Service Navigation Styles */
        .service-nav {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 0;
            margin-bottom: 2rem;
        }

        .service-nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .service-nav-btn {
            background: none;
            border: none;
            padding: 16px 20px;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            min-width: fit-content;
        }

        .service-nav-btn:hover {
            color: #495057;
            background: #e9ecef;
        }

        .service-nav-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .service-nav-btn i {
            font-size: 16px;
        }

        .service-nav-btn span {
            font-size: 13px;
        }

        /* Brand Logo Styles */
        .brand-logo {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            border-radius: 4px;
        }

        .nav-brand {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="brand-logo">
                <span class="brand-text">Movonte</span>
            </div>
            <div class="nav-links">
                <button id="logoutBtn" class="nav-link logout-btn" style="background: none; border: none; color: inherit; cursor: pointer; font-size: inherit;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <div class="breadcrumb-container">
            <span class="breadcrumb-item">Home</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="header-content">
                <div class="header-title">
                    <img src="favicons/favicon-32x32.png" alt="Movonte Logo" class="header-logo">
                    <h1>AI Assistant Management Dashboard</h1>
                </div>
                <div class="header-actions">
                    <div class="user-info" id="userInfo">
                        <i class="fas fa-user"></i>
                        <span id="userName">Cargando...</span>
                        <span class="user-role" id="userRole">user</span>
                    </div>
                    <button class="settings-btn" id="settingsBtn">
                        <i class="fas fa-cog"></i>
                        <span>Ajustes</span>
                    </button>
                </div>
            </div>
            <p>Configure AI assistants, manage project integrations, and control automated responses</p>
        </div>

        <!-- Service Navigation -->
        <div class="service-nav">
            <div class="service-nav-container">
                <button class="service-nav-btn active" data-service="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </button>
                <button class="service-nav-btn" data-service="ai-config">
                    <i class="fas fa-robot"></i>
                    <span>AI Configuration</span>
                </button>
                <button class="service-nav-btn" data-service="webhook-integration">
                    <i class="fas fa-webhook"></i>
                    <span>Webhook Integration</span>
                </button>
                <button class="service-nav-btn" data-service="auto-disable-rules">
                    <i class="fas fa-toggle-on"></i>
                    <span>Auto-Disable Rules</span>
                </button>
                <button class="service-nav-btn" data-service="manual-ticket-control">
                    <i class="fas fa-ticket-alt"></i>
                    <span>Manual Ticket Control</span>
                </button>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number" id="totalAssistants">-</div>
                    <div class="stat-label">AVAILABLE ASSISTANTS</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="totalServices">2</div>
                    <div class="stat-label">CONFIGURED SERVICES</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-content">
                <div class="stat-number" id="activeServices">-</div>
                    <div class="stat-label">ACTIVE SERVICES</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number" id="systemUptime">98.5%</div>
                    <div class="stat-label">SYSTEM UPTIME</div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                <!-- AI Assistants Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>AI Assistant Configuration</h2>
                    </div>
                    <div class="section-content">
                        <!-- Global Active Assistant Info -->
                        <div class="global-assistant-info">
                            <div class="info-label">Global Active Assistant:</div>
                            <div class="info-value" id="globalAssistantName">-</div>
                        </div>
                        
                        <div id="assistantsList" class="assistant-list">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Loading assistants...</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Project Management Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>AI Enabled Projects</h2>
                    </div>
                    <div class="section-content">
                                        <div class="form-group">
                            <label for="activeProject" class="form-label">Active Jira Project</label>
                            <select id="activeProject" class="form-select">
                                <option value="">Loading projects...</option>
                            </select>
                        </div>
                        <div class="project-info">
                            <div class="info-row">
                                <span class="info-label">Current Project:</span>
                                <span class="info-value" id="currentProjectName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Project Key:</span>
                                <span class="info-value" id="currentProjectKey">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Remote Server Project Management Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Remote Server Integration</h2>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label for="remoteServerUrl" class="form-label">Remote Server URL</label>
                            <input type="text" id="remoteServerUrl" class="form-input" 
                                   placeholder="https://form.movonte.com" 
                                   value="https://form.movonte.com">
                        </div>
                        
                    <div class="form-group">
                            <label for="remoteActiveProject" class="form-label">Remote Active Project</label>
                            <select id="remoteActiveProject" class="form-select">
                                <option value="">Loading remote projects...</option>
                            </select>
                        </div>
                        
                        <div class="remote-project-info">
                            <div class="info-row">
                                <span class="info-label">Remote Current Project:</span>
                                <span class="info-value" id="remoteCurrentProjectName">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Remote Project Key:</span>
                                <span class="info-value" id="remoteCurrentProjectKey">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Service Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Service Management</h2>
                    </div>
                    <div class="section-content">
                        <!-- Landing Page Service -->
                        <div class="service-config">
                            <div class="service-header">
                                <div class="service-info">
                                    <div class="service-name">Landing Page</div>
                                    <div class="service-details">
                                        <div class="detail-row">
                                            <span class="detail-label">Current Assistant:</span>
                                            <span class="detail-value" id="landing-assistant-name">-</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Service ID:</span>
                                            <span class="detail-value">landing-page</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Jira Project:</span>
                                            <span class="detail-value" id="landing-project">-</span>
                                        </div>
                                        <div class="detail-row">
                                            <span class="detail-label">Last Updated:</span>
                                            <span class="detail-value" id="landing-last-updated">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="service-controls">
                                <div class="control-section">
                                    <label class="control-label">CHANGE ASSISTANT</label>
                                    <select class="control-select" id="assistant-landing-page">
                                        <option value="">Select an assistant...</option>
                                    </select>
                                </div>
                                <div class="control-buttons">
                                    <button class="btn btn-primary apply-change-btn" data-service-id="landing-page">
                                        APPLY
                                    </button>
                                    <button class="btn btn-secondary toggle-service-btn" 
                                            data-service-id="landing-page" data-is-active="false">
                                        DEACTIVATE
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Status-Based Disable Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Automatic AI Disable Rules</h2>
                        <p>Set up rules to automatically disable AI when tickets change to specific statuses</p>
                    </div>
                    <div class="section-content">
                        <!-- Status-Based Disable Configuration -->
                            <div class="status-disable-config-form status-control-section">
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" id="statusDisableEnabled">
                                    <span class="checkmark"></span>
                                    Enable automatic AI disable based on ticket status
                                </label>
                            </div>
                            <div class="form-group" id="statusSelectionGroup" style="display: none;">
                                <label for="triggerStatuses" class="form-label">Select Statuses to Trigger AI Disable</label>
                                <div id="statusCheckboxes" class="status-checkboxes">
                                    <!-- Status checkboxes will be populated here -->
                                </div>
                                <small class="form-help">AI will be automatically disabled when tickets change to any of these statuses</small>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="saveStatusDisableBtn">Save Configuration</button>
                                <button type="button" class="btn btn-secondary" id="loadStatusDisableBtn">Load Current Config</button>
                            </div>
                        </div>
                        <div class="status-info">
                            <div class="info-item">
                                <span class="info-label">Status-Based Disable:</span>
                                <span id="statusDisableStatus" class="info-value">Not configured</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Trigger Statuses:</span>
                                <span id="triggerStatusesList" class="info-value">None</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Webhook Configuration Section -->
                <div class="section-card">
                    <div class="section-header">
                        <h2>Webhook Configuration</h2>
                        <p>Configure webhook integrations to send AI responses to external systems</p>
                    </div>
                    <div class="section-content">
                        <!-- Webhook URL Configuration -->
                        <div class="webhook-config-form webhook-section">
                            <div class="form-group">
                                <label for="savedWebhookSelect" class="form-label">Select Saved Webhook</label>
                                <select id="savedWebhookSelect" class="form-select">
                                    <option value="">Choose a saved webhook...</option>
                                </select>
                                <small class="form-help">Select from previously saved webhook URLs</small>
                            </div>
                            <div class="form-group">
                                <label for="webhookUrl" class="form-label">Jira Automation Webhook URL</label>
                                <input type="url" id="webhookUrl" class="form-input" 
                                       placeholder="https://api-private.atlassian.com/automation/webhooks/jira/a/..."
                                       value="">
                                <small class="form-help">URL del webhook de Jira Automation (formato: api-private.atlassian.com/automation/webhooks/...)</small>
                            </div>
                            <div class="form-group" id="newWebhookFields" style="display: none;">
                                <label for="webhookName" class="form-label">Webhook Name (for saving)</label>
                                <input type="text" id="webhookName" class="form-input" 
                                       placeholder="e.g., Jira Production Webhook"
                                       value="">
                                <small class="form-help">Give this webhook a name to save it for future use</small>
                            </div>
                            <div class="form-group" id="newWebhookDescription" style="display: none;">
                                <label for="webhookDescription" class="form-label">Description (optional)</label>
                                <textarea id="webhookDescription" class="form-input" rows="2" 
                                          placeholder="Brief description of this webhook..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="webhookAssistant" class="form-label">Webhook Assistant</label>
                                <select id="webhookAssistant" class="form-select">
                                    <option value="">Select an assistant for webhook flow...</option>
                                </select>
                            </div>
                            
                            <!-- Webhook Filter Configuration -->
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="webhookFilterEnabled" class="form-check-input">
                                    <label for="webhookFilterEnabled" class="form-check-label">
                                        <strong>Enable Webhook Filter</strong>
                                    </label>
                                </div>
                                <small class="form-help">Enable/disable the webhook filtering function. The actual filtering logic is handled by the parallel assistant (Escalate agent).</small>
                            </div>
                            
                            <div id="webhookFilterConfig" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Filter Information:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>The <strong>Escalate agent</strong> analyzes each conversation and responds with JSON: <code>{"value": "Yes/No", "reason": "...", "confidence": 0.95}</code></li>
                                        <li>If <strong>value = "Yes"</strong>: Webhook is sent (human intervention needed)</li>
                                        <li>If <strong>value = "No"</strong>: Webhook is blocked (AI can handle it)</li>
                                        <li>This filter only enables/disables the filtering function</li>
                                    </ul>
                                </div>
                                
                                <div class="form-group">
                                    <label for="webhookFilterCondition" class="form-label">Filter Condition</label>
                                    <select id="webhookFilterCondition" class="form-select" disabled>
                                        <option value="response_value">Response Value (Auto-detected)</option>
                                    </select>
                                    <small class="form-help">Automatically detects Yes/No from Escalate agent response</small>
                                </div>
                                
                                <div class="form-group">
                                    <label for="webhookFilterValue" class="form-label">Filter Value</label>
                                    <select id="webhookFilterValue" class="form-select" disabled>
                                        <option value="Yes">Yes (Send webhook when escalation needed)</option>
                                        <option value="No">No (Never send webhook)</option>
                                    </select>
                                    <small class="form-help">Currently set to "Yes" - only sends webhook when Escalate agent determines human intervention is needed</small>
                                </div>
                                
                                <div class="form-group">
                                    <button class="btn btn-warning" id="saveWebhookFilterBtn">
                                        <i class="fas fa-filter"></i> Save Filter Configuration
                                    </button>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-info" id="createNewWebhookBtn">
                                    <i class="fas fa-plus"></i> Create New Webhook
                                </button>
                                <button class="btn btn-success" id="saveWebhookBtn" style="display: none;">
                                    <i class="fas fa-bookmark"></i> Save Webhook
                                </button>
                                <button class="btn btn-primary" id="saveWebhookConfigBtn">
                                    <i class="fas fa-save"></i> Save Webhook Configuration
                                </button>
                                <button class="btn btn-secondary" id="testWebhookBtn">
                                    <i class="fas fa-test-tube"></i> Test Webhook
                                </button>
                                <button class="btn btn-warning" id="disableWebhookBtn">
                                    <i class="fas fa-ban"></i> Disable Webhook
                                </button>
                                <button class="btn btn-danger" id="deleteWebhookBtn" style="display: none;">
                                    <i class="fas fa-trash"></i> Delete Saved Webhook
                                </button>
                                <button class="btn btn-secondary" id="cancelNewWebhookBtn" style="display: none;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        </div>

                        <!-- Webhook Status -->
                        <div class="webhook-status">
                            <div class="info-row">
                                <span class="info-label">Webhook Status:</span>
                                <span class="info-value" id="webhookStatus">Not configured</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Webhook Type:</span>
                                <span class="info-value" id="webhookType">Jira Automation</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Last Test:</span>
                                <span class="info-value" id="webhookLastTest">Never</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Token Status:</span>
                                <span class="info-value" id="webhookTokenStatus">Not configured</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ticket Control Section -->
                <div class="section-card ticket-control-section">
                    <div class="section-header">
                        <h2>Ticket Control</h2>
                        <p>Manually disable AI assistant for specific Jira tickets</p>
                    </div>
                    <div class="section-content">
                        <!-- Disable Assistant Form -->
                        <div class="ticket-control-form">
                            <div class="form-group">
                                <label for="ticketIssueKey" class="form-label">Jira Ticket Key</label>
                                <input type="text" id="ticketIssueKey" class="form-input" 
                                       placeholder="e.g., TI-123" required>
                            </div>
                            <div class="form-group">
                                <label for="disableReason" class="form-label">Reason (Optional)</label>
                                <textarea id="disableReason" class="form-textarea" 
                                          placeholder="Reason for disabling the AI assistant..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-danger" id="disableTicketBtn">
                                    <i class="fas fa-ban"></i> Disable Assistant
                                </button>
                                <button class="btn btn-success" id="enableTicketBtn">
                                    <i class="fas fa-check"></i> Enable Assistant
                                </button>
                                <button class="btn btn-secondary" id="checkTicketBtn">
                                    <i class="fas fa-search"></i> Check Status
                                </button>
                            </div>
                        </div>

                        <!-- Disabled Tickets List -->
                        <div class="disabled-tickets-section">
                            <div class="section-subheader">
                                <h3>Currently Disabled Tickets</h3>
                                <button class="btn btn-sm btn-secondary" id="refreshDisabledBtn">
                                    <i class="fas fa-refresh"></i> Refresh
                                </button>
                            </div>
                            <div id="disabledTicketsList" class="disabled-tickets-list">
                                <div class="loading-state">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading disabled tickets...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="activity-section">
            <div class="section-card">
                <div class="section-header">
                    <h2>
                        <i class="fas fa-file-alt"></i>
                        Recent Activity
                    </h2>
                </div>
                <div class="section-content">
                    <div id="recentActivity" class="activity-list">
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">Landing Page service updated successfully with Chatbot Test V3</div>
                                <div class="activity-time">Today at 11:08 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">Jira Integration service has been activated</div>
                                <div class="activity-time">Today at 10:45 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator warning"></div>
                            <div class="activity-content">
                                <div class="activity-text">Performance degradation detected for Chatbot Test V2</div>
                                <div class="activity-time">Today at 09:30 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator info"></div>
                            <div class="activity-content">
                                <div class="activity-text">System backup completed successfully</div>
                                <div class="activity-time">Today at 08:15 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator error"></div>
                            <div class="activity-content">
                                <div class="activity-text">Connection timeout for assistant asst_8ttODMww5jd42lqe4nZ7JjG0</div>
                                <div class="activity-time">Today at 07:22 AM</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-indicator success"></div>
                            <div class="activity-content">
                                <div class="activity-text">New assistant "Chatbot Test V3" has been registered</div>
                                <div class="activity-time">Yesterday at 16:45 PM</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Configuración del Sistema</h2>
                    <button class="modal-close" id="closeSettingsModalHeaderBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-tabs">
                        <button class="tab-btn active" id="changePasswordTabBtn">
                            <i class="fas fa-key"></i> Cambiar Contraseña
                        </button>
                        <button class="tab-btn" id="userManagementTabBtn" style="display: none;">
                            <i class="fas fa-users"></i> Gestión de Usuarios
                        </button>
                    </div>
                    
                    <!-- Change Password Tab -->
                    <div id="changePasswordTab" class="settings-tab-content">
                        <h3>Cambiar Contraseña</h3>
                        <form id="changePasswordForm">
                            <div class="form-group">
                                <label for="currentPassword" class="form-label">Contraseña Actual</label>
                                <input type="password" id="currentPassword" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="newPassword" class="form-label">Nueva Contraseña</label>
                                <input type="password" id="newPassword" class="form-input" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword" class="form-label">Confirmar Nueva Contraseña</label>
                                <input type="password" id="confirmPassword" class="form-input" required minlength="6">
                            </div>
                        </form>
                    </div>
                    
                    <!-- User Management Tab (Admin Only) -->
                    <div id="userManagementTab" class="settings-tab-content" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3>Gestión de Usuarios</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" id="testLoadUsersBtn" style="font-size: 12px;">
                                    <i class="fas fa-refresh"></i> Test
                                </button>
                                <button class="btn btn-primary" id="createUserBtn">
                                    <i class="fas fa-plus"></i> Nuevo Usuario
                                </button>
                            </div>
                        </div>
                        <div id="usersList">
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #3b82f6; margin-bottom: 10px;"></i>
                                <p>Cargando usuarios...</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="closeSettingsModalBtn">Cerrar</button>
                    <button class="btn btn-primary" id="savePasswordBtn">Guardar Contraseña</button>
                </div>
            </div>
        </div>

        <!-- Create User Modal -->
        <div id="createUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Crear Nuevo Usuario</h2>
                    <button class="modal-close" id="closeCreateUserModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="createUserForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUsername" class="form-label">Usuario</label>
                                <input type="text" id="newUsername" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="newUserEmail" class="form-label">Email</label>
                                <input type="email" id="newUserEmail" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserPassword" class="form-label">Contraseña</label>
                                <input type="password" id="newUserPassword" class="form-input" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label for="newUserRole" class="form-label">Rol</label>
                                <select id="newUserRole" class="form-select" required>
                                    <option value="user">Usuario</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelCreateUserBtn">Cancelar</button>
                    <button class="btn btn-primary" id="confirmCreateUserBtn">Crear Usuario</button>
                </div>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Editar Usuario</h2>
                    <button class="modal-close" id="closeEditUserModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUsername" class="form-label">Usuario</label>
                                <input type="text" id="editUsername" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="editUserEmail" class="form-label">Email</label>
                                <input type="email" id="editUserEmail" class="form-input" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editUserRole" class="form-label">Rol</label>
                                <select id="editUserRole" class="form-select" required>
                                    <option value="user">Usuario</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="editUserStatus" class="form-label">Estado</label>
                                <select id="editUserStatus" class="form-select" required>
                                    <option value="true">Activo</option>
                                    <option value="false">Inactivo</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelEditUserBtn">Cancelar</button>
                    <button class="btn btn-primary" id="confirmUpdateUserBtn">Guardar Cambios</button>
                </div>
            </div>
        </div>

        <!-- Change User Password Modal -->
        <div id="changeUserPasswordModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Cambiar Contraseña de Usuario</h2>
                    <button class="modal-close" id="closeChangeUserPasswordModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="changeUserPasswordForm">
                        <input type="hidden" id="changePasswordUserId">
                        <div class="form-group">
                            <label for="newUserPasswordInput" class="form-label">Nueva Contraseña</label>
                            <input type="password" id="newUserPasswordInput" class="form-input" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmNewUserPassword" class="form-label">Confirmar Nueva Contraseña</label>
                            <input type="password" id="confirmNewUserPassword" class="form-input" required minlength="6">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelChangeUserPasswordBtn">Cancelar</button>
                    <button class="btn btn-primary" id="confirmChangeUserPasswordBtn">Cambiar Contraseña</button>
                </div>
            </div>
        </div>

        <!-- User Permissions Modal -->
        <div id="userPermissionsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Gestionar Permisos de Usuario</h2>
                    <button class="modal-close" id="closeUserPermissionsModalBtn">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="permissions-info">
                        <p><strong>Usuario:</strong> <span id="permissionsUserName">-</span></p>
                        <p class="permissions-description">Selecciona los módulos a los que este usuario tendrá acceso:</p>
                    </div>
                    
                    <form id="userPermissionsForm">
                        <input type="hidden" id="permissionsUserId">
                        
                        <div class="permissions-grid">
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_serviceManagement" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>Service Management</strong>
                                        <small>Gestión de servicios y asistentes de IA</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_automaticAIDisableRules" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>Automatic AI Disable Rules</strong>
                                        <small>Configuración de reglas automáticas de desactivación</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_webhookConfiguration" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>Webhook Configuration</strong>
                                        <small>Configuración de webhooks e integraciones</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_ticketControl" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>Ticket Control</strong>
                                        <small>Control manual de tickets y asistente de IA</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_aiEnabledProjects" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>AI Enabled Projects</strong>
                                        <small>Gestión de proyectos habilitados para IA</small>
                                    </span>
                                </label>
                            </div>
                            
                            <div class="permission-item">
                                <label class="permission-label">
                                    <input type="checkbox" id="perm_remoteServerIntegration" class="permission-checkbox">
                                    <span class="permission-text">
                                        <strong>Remote Server Integration</strong>
                                        <small>Integración con servidores remotos</small>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelUserPermissionsBtn">Cancelar</button>
                    <button class="btn btn-primary" id="saveUserPermissionsBtn">Guardar Permisos</button>
                </div>
            </div>
        </div>

    <script>
        class CEODashboard {
            constructor() {
                this.assistants = [];
                this.projects = [];
                this.serviceConfigs = [];
                this.activeProject = '';
                this.activeAssistant = '';
                this.remoteProjects = [];
                this.remoteActiveProject = '';
                this.remoteServerUrl = 'https://form.movonte.com';
                this.authToken = localStorage.getItem('authToken');
                this.initialize();
            }

            async initialize() {
                // Verificar autenticación
                if (!this.authToken) {
                    console.log('❌ No hay token de autenticación, redirigiendo al login');
                    window.location.href = '/login';
                    return;
                }
                
                // Cargar perfil de usuario primero para obtener permisos
                await this.loadUserProfile();
                
                // Cargar dashboard (siempre accesible)
                await this.loadDashboard();
                
                // Cargar datos solo si el usuario tiene permisos
                if (this.currentUser) {
                    if (this.currentUser.role === 'admin' || this.currentUser.permissions?.aiEnabledProjects) {
                        await this.loadProjects();
                    }
                    
                    if (this.currentUser.role === 'admin' || this.currentUser.permissions?.remoteServerIntegration) {
                        await this.loadRemoteProjects();
                    }
                    
                    if (this.currentUser.role === 'admin' || this.currentUser.permissions?.ticketControl) {
                        await this.loadDisabledTickets();
                    }
                    
                    if (this.currentUser.role === 'admin' || this.currentUser.permissions?.webhookConfiguration) {
                        await this.loadSavedWebhooks();
                        await this.updateWebhookStatus();
                    }
                    
                    if (this.currentUser.role === 'admin' || this.currentUser.permissions?.automaticAIDisableRules) {
                        await this.loadStatusDisableConfig();
                    }
                }
                
                this.setupEventListeners();
                this.setupServiceNavigation();
            }

            // Método para hacer peticiones autenticadas
            async authenticatedFetch(url, options = {}) {
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.authToken}`
                    }
                };
                
                const mergedOptions = {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...options.headers
                    }
                };
                
                try {
                    const response = await fetch(url, mergedOptions);
                    
                    // Si la respuesta es 401, redirigir al login
                    if (response.status === 401) {
                        console.log('❌ Token inválido, redirigiendo al login');
                        localStorage.removeItem('authToken');
                        window.location.href = '/login';
                        return null;
                    }
                    
                    // Si la respuesta es 403, es un error de permisos, no redirigir
                    if (response.status === 403) {
                        console.log('❌ Acceso denegado - permisos insuficientes para:', url);
                        return response; // Devolver la respuesta para que el método que la llama pueda manejarla
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Error en petición autenticada:', error);
                    throw error;
                }
            }

            async loadDashboard() {
                try {
                    console.log('🔄 Loading dashboard data...');
                    const response = await this.authenticatedFetch('/api/admin/dashboard');
                    if (!response) return; // Si no hay respuesta (redirigido al login)
                    const data = await response.json();

                    console.log('📊 Dashboard data received:', data);

                    if (data.success) {
                        this.assistants = data.data.assistants;
                        this.projects = data.data.projects;
                        this.serviceConfigs = data.data.serviceConfigurations;
                        this.activeProject = data.data.activeProject;
                        this.activeAssistant = data.data.activeAssistant;
                        
                        console.log('✅ Data loaded:', {
                            assistants: this.assistants.length,
                            projects: this.projects.length,
                            serviceConfigs: this.serviceConfigs.length,
                            activeProject: this.activeProject,
                            activeAssistant: this.activeAssistant
                        });
                        
                        this.updateStats(data.data);
                        this.renderAssistants();
                        this.renderServices();
                        this.renderProjects();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('❌ Error loading dashboard:', error);
                    this.showStatus(`Error loading dashboard: ${error.message}`, 'error');
                }
            }

            async loadProjects() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/projects');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        this.projects = data.projects;
                        this.renderProjects();
                    }
                } catch (error) {
                    console.error('Error loading projects:', error);
                }
            }

            updateStats(data) {
                document.getElementById('totalAssistants').textContent = data.totalAssistants;
                document.getElementById('activeServices').textContent = 
                    this.serviceConfigs.filter(s => s.isActive && s.serviceId === 'landing-page').length;
            }

            renderAssistants() {
                const container = document.getElementById('assistantsList');
                
                                 if (this.assistants.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-robot"></i><span>No assistants available</span></div>';
                     return;
                 }

                container.innerHTML = this.assistants.map(assistant => {
                    // Determinar el estado del asistente
                    const isActive = assistant.isActive || false;
                    const isGlobalActive = assistant.isGlobalActive || false;
                    
                    // Crear texto de estado simplificado
                    let statusText = 'INACTIVE';
                    if (isActive) {
                        statusText = 'ACTIVE';
                    }
                    
                    return `
                        <div class="assistant-item ${isActive ? 'active' : ''}">
                            <div class="assistant-info">
                         <div class="assistant-name">${assistant.name || 'Unnamed'}</div>
                         <div class="assistant-details">
                                    <span class="assistant-id">ID: ${assistant.id}</span>
                                    <span class="assistant-model">Model: ${assistant.model}</span>
                                </div>
                            </div>
                            <div class="assistant-status">
                                <span class="status-dot ${isActive ? 'active' : 'inactive'}"></span>
                                <span class="status-text ${isActive ? 'active' : 'inactive'}">
                                    ${statusText}
                                </span>
                         </div>
                     </div>
                    `;
                }).join('');
            }

            renderProjects() {
                const select = document.getElementById('activeProject');
                const currentProjectName = document.getElementById('currentProjectName');
                const currentProjectKey = document.getElementById('currentProjectKey');
                
                if (this.projects.length === 0) {
                    select.innerHTML = '<option value="">No projects available</option>';
                     return;
                 }

                select.innerHTML = this.projects.map(project => `
                    <option value="${project.key}" ${project.key === this.activeProject ? 'selected' : ''}>
                        ${project.name} (${project.key})
                    </option>
                `).join('');

                // Update current project info
                const currentProject = this.projects.find(p => p.key === this.activeProject);
                if (currentProject) {
                    currentProjectName.textContent = currentProject.name;
                    currentProjectKey.textContent = currentProject.key;
                } else {
                    currentProjectName.textContent = '-';
                    currentProjectKey.textContent = '-';
                }
            }

            renderServices() {
                // Populate assistant dropdowns
                this.populateServiceAssistantDropdowns();
                
                // Update service information
                this.updateServiceInfo();
                
                // Setup event listeners (only once)
                this.setupDynamicEventListeners();
             }

            populateServiceAssistantDropdowns() {
                // Landing Page dropdown
                const landingSelect = document.getElementById('assistant-landing-page');
                if (landingSelect) {
                    landingSelect.innerHTML = '<option value="">Select an assistant...</option>';
                    
                    console.log('Populating dropdown with assistants:', this.assistants);
                    
                    this.assistants.forEach(assistant => {
                        const option = document.createElement('option');
                        option.value = assistant.id;
                        option.textContent = assistant.name || `Assistant ${assistant.id.slice(0, 8)}`;
                        landingSelect.appendChild(option);
                    });
                }

                // Webhook Assistant dropdown
                const webhookSelect = document.getElementById('webhookAssistant');
                if (webhookSelect) {
                    webhookSelect.innerHTML = '<option value="">Select an assistant...</option>';
                    
                    this.assistants.forEach(assistant => {
                        const option = document.createElement('option');
                        option.value = assistant.id;
                        option.textContent = assistant.name || `Assistant ${assistant.id.slice(0, 8)}`;
                        webhookSelect.appendChild(option);
                    });
                }
            }

            updateServiceInfo() {
                console.log('🔄 Updating service info...');
                console.log('Service configs:', this.serviceConfigs);
                console.log('Active project:', this.activeProject);
                
                // Find service configurations
                const landingService = this.serviceConfigs.find(s => s.serviceId === 'landing-page');
                console.log('Landing service found:', landingService);
                
                // Update Landing Page service
                if (landingService) {
                    console.log('✅ Updating landing service info:', landingService);
                    document.getElementById('landing-assistant-name').textContent = landingService.assistantName || '-';
                    document.getElementById('landing-last-updated').textContent = new Date(landingService.lastUpdated).toLocaleString();
                    document.getElementById('landing-project').textContent = this.activeProject || '-';
                    
                    // Set selected assistant
                    const landingSelect = document.getElementById('assistant-landing-page');
                    if (landingSelect) {
                        landingSelect.value = landingService.assistantId || '';
                        console.log('Set dropdown value to:', landingService.assistantId);
                    }
                    
                    // Update toggle button
                    const landingToggle = document.querySelector('[data-service-id="landing-page"].toggle-service-btn');
                    if (landingToggle) {
                        landingToggle.textContent = landingService.isActive ? 'DEACTIVATE' : 'ACTIVATE';
                        landingToggle.className = `btn ${landingService.isActive ? 'btn-secondary' : 'btn-success'} toggle-service-btn`;
                        landingToggle.dataset.isActive = !landingService.isActive;
                    }
                } else {
                    console.log('❌ No landing service configuration found');
                    // Si no hay configuración, mostrar valores por defecto
                    document.getElementById('landing-assistant-name').textContent = '-';
                    document.getElementById('landing-last-updated').textContent = '-';
                    document.getElementById('landing-project').textContent = this.activeProject || '-';
                    
                    const landingSelect = document.getElementById('assistant-landing-page');
                    if (landingSelect) {
                        landingSelect.value = '';
                    }
                }

                // Update Webhook Parallel service
                const webhookService = this.serviceConfigs.find(s => s.serviceId === 'webhook-parallel');
                if (webhookService) {
                    console.log('✅ Updating webhook service info:', webhookService);
                    
                    // Set selected assistant for webhook
                    const webhookSelect = document.getElementById('webhookAssistant');
                    if (webhookSelect) {
                        webhookSelect.value = webhookService.assistantId || '';
                        console.log('Set webhook dropdown value to:', webhookService.assistantId);
                    }
                } else {
                    console.log('❌ No webhook service configuration found');
                    // Si no hay configuración, limpiar el dropdown
                    const webhookSelect = document.getElementById('webhookAssistant');
                    if (webhookSelect) {
                        webhookSelect.value = '';
                    }
                }
                
                // Mostrar información del asistente activo global
                this.updateGlobalAssistantInfo();
            }

            updateGlobalAssistantInfo() {
                // Mostrar información del asistente activo global
                const globalAssistant = this.assistants.find(a => a.id === this.activeAssistant);
                const globalAssistantElement = document.getElementById('globalAssistantName');
                
                if (globalAssistant && globalAssistantElement) {
                    globalAssistantElement.textContent = globalAssistant.name || 'Unnamed';
                    console.log('Asistente activo global:', globalAssistant.name);
                } else if (globalAssistantElement) {
                    globalAssistantElement.textContent = '-';
                }
            }

            async applyAssistantChange(serviceId) {
                console.log(`🔄 applyAssistantChange called with serviceId: ${serviceId}`);
                
                const selectElement = document.getElementById(`assistant-${serviceId}`);
                console.log(`🔍 Select element found:`, selectElement);
                
                if (!selectElement) {
                    console.error(`❌ Select element not found for serviceId: ${serviceId}`);
                    this.showStatus(`Select element not found for service: ${serviceId}`, 'error');
                    return;
                }
                
                const selectedAssistantId = selectElement.value;
                console.log(`📋 Selected assistant ID: ${selectedAssistantId}`);
                
                if (!selectedAssistantId) {
                    this.showStatus('Please select an assistant first', 'error');
                    return;
                }

                const assistant = this.assistants.find(a => a.id === selectedAssistantId);
                console.log(`🔍 Assistant found:`, assistant);
                
                if (!assistant) {
                    this.showStatus('Assistant not found', 'error');
                    return;
                }

                try {
                    console.log(`🔄 Aplicando cambio para servicio: ${serviceId}`);
                    console.log(`📋 Asistente seleccionado:`, assistant);
                    
                    const response = await this.authenticatedFetch(`/api/admin/services/${serviceId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            assistantId: selectedAssistantId,
                            assistantName: assistant.name || 'Sin nombre'
                        })
                    });
                    
                    console.log(`📡 Response received:`, response);
                    
                    if (!response) return;

                    const data = await response.json();
                    console.log(`📊 Response data:`, data);
                    
                    if (data.success) {
                        console.log(`✅ Change applied successfully:`, data);
                        this.showStatus(`Assistant "${assistant.name}" applied to ${serviceId}`, 'success');
                        
                        // Add activity log
                        this.addActivity(`Assistant "${assistant.name}" applied to ${serviceId}`, 'success');
                        
                        // Reload dashboard to update assistant statuses
                        await this.loadDashboard();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error(`❌ Error applying change:`, error);
                    this.showStatus(`Error applying change: ${error.message}`, 'error');
                }
            }

            async toggleService(serviceId, isActive) {
                try {
                    const response = await this.authenticatedFetch(`/api/admin/services/${serviceId}/toggle`, {
                        method: 'PATCH',
                        body: JSON.stringify({ isActive })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                                         if (data.success) {
                         this.showStatus(`Service ${serviceId} ${isActive ? 'activated' : 'deactivated'}`, 'success');
                        
                        // Add activity log
                        this.addActivity(`Service ${serviceId} ${isActive ? 'activated' : 'deactivated'}`, 'success');
                        
                        // Reload dashboard to update assistant statuses
                        await this.loadDashboard();
                     } else {
                         throw new Error(data.error);
                     }
                 } catch (error) {
                     this.showStatus(`Error changing status: ${error.message}`, 'error');
                 }
            }

            async changeActiveProject(projectKey) {
                if (!projectKey) return;

                try {
                    const response = await this.authenticatedFetch('/api/admin/projects/set-active', {
                        method: 'POST',
                        body: JSON.stringify({ projectKey })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                                         if (data.success) {
                        this.activeProject = projectKey;
                        this.showStatus(`Project changed to: ${projectKey}`, 'success');
                        this.renderProjects();
                        this.addActivity(`Project changed to ${projectKey}`, 'success');
                     } else {
                         throw new Error(data.error);
                     }
                 } catch (error) {
                    this.showStatus(`Error changing project: ${error.message}`, 'error');
                }
            }

            addActivity(text, type) {
                const activityList = document.getElementById('recentActivity');
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });

                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `
                    <div class="activity-indicator ${type}"></div>
                    <div class="activity-content">
                        <div class="activity-text">${text}</div>
                        <div class="activity-time">Today at ${timeString}</div>
                    </div>
                `;

                activityList.insertBefore(activityItem, activityList.firstChild);
                
                // Keep only last 6 activities
                while (activityList.children.length > 6) {
                    activityList.removeChild(activityList.lastChild);
                 }
            }

            showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.textContent = message;
                statusDiv.className = `status-message status-${type}`;
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }

            async logout() {
                try {
                    // Llamar al endpoint de logout
                    await this.authenticatedFetch('/api/auth/logout', {
                        method: 'POST'
                    });
                } catch (error) {
                    console.log('Error en logout:', error);
                } finally {
                    // Limpiar token y redirigir
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                }
            }

                         setupEventListeners() {
                // Event listener para logout
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    this.logout();
                });
                
                // Event listener para cambiar proyecto activo
                document.getElementById('activeProject')?.addEventListener('change', (e) => {
                    this.changeActiveProject(e.target.value);
                });
                
                // Event listeners para servidor remoto
                document.getElementById('remoteServerUrl')?.addEventListener('change', (e) => {
                    this.remoteServerUrl = e.target.value;
                    this.loadRemoteProjects();
                });
                
                document.getElementById('remoteActiveProject')?.addEventListener('change', (e) => {
                    this.changeRemoteProject(e.target.value);
                });

                // === USER MANAGEMENT EVENT LISTENERS ===
                
                // Settings modal tabs
                document.getElementById('changePasswordTabBtn')?.addEventListener('click', () => {
                    this.showSettingsTab('changePassword');
                });
                
                document.getElementById('userManagementTabBtn')?.addEventListener('click', () => {
                    this.showSettingsTab('userManagement');
                });
                
                // Settings modal buttons
                document.getElementById('closeSettingsModalBtn')?.addEventListener('click', () => {
                    this.closeModal('settingsModal');
                });
                
                document.getElementById('closeSettingsModalHeaderBtn')?.addEventListener('click', () => {
                    this.closeModal('settingsModal');
                });
                
                document.getElementById('savePasswordBtn')?.addEventListener('click', () => {
                    this.savePassword();
                });
                
                // Create user modal buttons
                document.getElementById('createUserBtn')?.addEventListener('click', () => {
                    this.showCreateUserModal();
                });
                
                // Test load users button
                document.getElementById('testLoadUsersBtn')?.addEventListener('click', () => {
                    console.log('🧪 Test: Cargando usuarios manualmente...');
                    this.loadUsers();
                });
                
                document.getElementById('closeCreateUserModalBtn')?.addEventListener('click', () => {
                    this.closeModal('createUserModal');
                });
                
                document.getElementById('cancelCreateUserBtn')?.addEventListener('click', () => {
                    this.closeModal('createUserModal');
                });
                
                document.getElementById('confirmCreateUserBtn')?.addEventListener('click', () => {
                    this.createUser();
                });
                
                // Edit user modal buttons
                document.getElementById('closeEditUserModalBtn')?.addEventListener('click', () => {
                    this.closeModal('editUserModal');
                });
                
                document.getElementById('cancelEditUserBtn')?.addEventListener('click', () => {
                    this.closeModal('editUserModal');
                });
                
                document.getElementById('confirmUpdateUserBtn')?.addEventListener('click', () => {
                    this.updateUser();
                });
                
                // Change user password modal buttons
                document.getElementById('closeChangeUserPasswordModalBtn')?.addEventListener('click', () => {
                    this.closeModal('changeUserPasswordModal');
                });
                
                document.getElementById('cancelChangeUserPasswordBtn')?.addEventListener('click', () => {
                    this.closeModal('changeUserPasswordModal');
                });
                
                document.getElementById('confirmChangeUserPasswordBtn')?.addEventListener('click', () => {
                    this.changeUserPassword();
                });

                // User permissions modal buttons
                document.getElementById('closeUserPermissionsModalBtn')?.addEventListener('click', () => {
                    this.closeModal('userPermissionsModal');
                });
                
                document.getElementById('cancelUserPermissionsBtn')?.addEventListener('click', () => {
                    this.closeModal('userPermissionsModal');
                });
                
                document.getElementById('saveUserPermissionsBtn')?.addEventListener('click', () => {
                    this.saveUserPermissions();
                });

                // Ticket control event listeners
                document.getElementById('disableTicketBtn')?.addEventListener('click', () => {
                    this.disableTicketAssistant();
                });

                document.getElementById('enableTicketBtn')?.addEventListener('click', () => {
                    this.enableTicketAssistant();
                });

                document.getElementById('checkTicketBtn')?.addEventListener('click', () => {
                    this.checkTicketStatus();
                });

                document.getElementById('refreshDisabledBtn')?.addEventListener('click', () => {
                    this.loadDisabledTickets();
                });

                // Webhook configuration event listeners
                document.getElementById('saveWebhookConfigBtn')?.addEventListener('click', () => {
                    this.saveWebhookConfiguration();
                });

                document.getElementById('testWebhookBtn')?.addEventListener('click', () => {
                    this.testWebhook();
                });

                document.getElementById('disableWebhookBtn')?.addEventListener('click', () => {
                    this.disableWebhook();
                });

                // Webhook filter event listeners
                document.getElementById('webhookFilterEnabled')?.addEventListener('change', () => {
                    this.toggleWebhookFilterConfig();
                });

                document.getElementById('saveWebhookFilterBtn')?.addEventListener('click', () => {
                    this.saveWebhookFilter();
                });

                // Saved webhooks event listeners
                document.getElementById('createNewWebhookBtn')?.addEventListener('click', () => {
                    this.showNewWebhookFields();
                });

                document.getElementById('cancelNewWebhookBtn')?.addEventListener('click', () => {
                    this.hideNewWebhookFields();
                    this.clearWebhookForm();
                });

                document.getElementById('saveWebhookBtn')?.addEventListener('click', () => {
                    this.saveWebhook();
                });

                document.getElementById('deleteWebhookBtn')?.addEventListener('click', () => {
                    this.deleteSavedWebhook();
                });

                // Event listener for saved webhook selection
                document.getElementById('savedWebhookSelect')?.addEventListener('change', (e) => {
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    if (selectedOption.value) {
                        // Fill the form with selected webhook data
                        document.getElementById('webhookUrl').value = selectedOption.dataset.url || '';
                        document.getElementById('webhookName').value = selectedOption.dataset.name || '';
                        document.getElementById('webhookDescription').value = selectedOption.dataset.description || '';
                        document.getElementById('deleteWebhookBtn').style.display = 'inline-block';
                        // Hide new webhook fields when selecting a saved webhook
                        this.hideNewWebhookFields();
                    } else {
                        // Clear form and hide delete button
                        this.clearWebhookForm();
                    }
                });
             }

             setupDynamicEventListeners() {
                 // Event listeners para botones de aplicar cambio
                 document.querySelectorAll('.apply-change-btn').forEach(btn => {
                     // Remove existing listeners to avoid duplicates
                     btn.removeEventListener('click', this.handleApplyChange);
                     btn.addEventListener('click', this.handleApplyChange.bind(this));
                 });

                 // Event listeners para botones de toggle
                 document.querySelectorAll('.toggle-service-btn').forEach(btn => {
                     // Remove existing listeners to avoid duplicates
                     btn.removeEventListener('click', this.handleToggleService);
                     btn.addEventListener('click', this.handleToggleService.bind(this));
                 });
            }

            handleApplyChange(e) {
                console.log(`🔄 handleApplyChange called`);
                console.log(`🔍 Event target:`, e.target);
                console.log(`🔍 Dataset:`, e.target.dataset);
                
                const serviceId = e.target.dataset.serviceId;
                console.log(`🔍 Service ID: ${serviceId}`);
                
                this.applyAssistantChange(serviceId);
            }

            handleToggleService(e) {
                const serviceId = e.target.dataset.serviceId;
                const isActive = e.target.dataset.isActive === 'true';
                this.toggleService(serviceId, isActive);
            }

            // === REMOTE SERVER FUNCTIONS ===

            async loadRemoteProjects() {
                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/available`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteProjects = data.availableProjects || [];
                        this.renderRemoteProjects();
                        
                        // Cargar el proyecto activo después de renderizar los proyectos
                        await this.loadRemoteActiveProject();
                    } else {
                        throw new Error(data.error || 'Failed to load remote projects');
                    }
                } catch (error) {
                    console.error('Error loading remote projects:', error);
                    this.showStatus(`Error loading remote projects: ${error.message}`, 'error');
                }
            }

            async loadRemoteActiveProject() {
                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/current`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteActiveProject = data.currentProject?.key || '';
                        this.updateRemoteProjectInfo();
                        
                        // Actualizar el dropdown para mostrar el proyecto seleccionado
                        const select = document.getElementById('remoteActiveProject');
                        if (select && this.remoteActiveProject) {
                            select.value = this.remoteActiveProject;
                        }
                        
                        console.log(`✅ Remote active project loaded: ${this.remoteActiveProject}`);
                    }
                } catch (error) {
                    console.error('Error loading remote active project:', error);
                }
            }

            renderRemoteProjects() {
                const select = document.getElementById('remoteActiveProject');
                
                if (this.remoteProjects.length === 0) {
                    select.innerHTML = '<option value="">No remote projects available</option>';
                    return;
                }

                select.innerHTML = this.remoteProjects.map(project => `
                    <option value="${project.key}" ${project.key === this.remoteActiveProject ? 'selected' : ''}>
                        ${project.name} (${project.key})
                    </option>
                `).join('');
                
                console.log(`✅ Remote projects rendered: ${this.remoteProjects.length} projects, active: ${this.remoteActiveProject}`);
            }

            updateRemoteProjectInfo() {
                const currentProjectName = document.getElementById('remoteCurrentProjectName');
                const currentProjectKey = document.getElementById('remoteCurrentProjectKey');
                
                if (this.remoteActiveProject) {
                    const project = this.remoteProjects.find(p => p.key === this.remoteActiveProject);
                    currentProjectName.textContent = project ? project.name : '-';
                    currentProjectKey.textContent = this.remoteActiveProject;
                } else {
                    currentProjectName.textContent = '-';
                    currentProjectKey.textContent = '-';
                }
            }

            async changeRemoteProject(projectKey) {
                if (!projectKey) {
                    this.showStatus('Please select a remote project first', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${this.remoteServerUrl}/api/projects/set-active`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ projectKey })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.remoteActiveProject = projectKey;
                        this.updateRemoteProjectInfo();
                        this.showStatus(`Remote project changed to: ${projectKey}`, 'success');
                        this.addActivity(`Remote project changed to ${projectKey}`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to change remote project');
                    }
                } catch (error) {
                    console.error('Error changing remote project:', error);
                    this.showStatus(`Error changing remote project: ${error.message}`, 'error');
                }
            }

            // === TICKET CONTROL METHODS ===

            async loadDisabledTickets() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/tickets/disabled');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        this.renderDisabledTickets(data.data.disabledTickets);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error loading disabled tickets:', error);
                    this.showStatus(`Error loading disabled tickets: ${error.message}`, 'error');
                }
            }

            renderDisabledTickets(disabledTickets) {
                const container = document.getElementById('disabledTicketsList');
                
                if (disabledTickets.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><span>No tickets with disabled assistants</span></div>';
                    return;
                }

                container.innerHTML = disabledTickets.map(ticket => `
                    <div class="disabled-ticket-item">
                        <div class="ticket-info">
                            <div class="ticket-key">${ticket.issueKey}</div>
                            <div class="ticket-details">
                                <span class="ticket-reason">${ticket.reason}</span>
                                <span class="ticket-date">${new Date(ticket.disabledAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="ticket-actions">
                            <button class="btn btn-sm btn-success enable-ticket-btn" data-issue-key="${ticket.issueKey}">
                                <i class="fas fa-check"></i> Enable
                            </button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners for enable buttons
                document.querySelectorAll('.enable-ticket-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const issueKey = e.target.dataset.issueKey;
                        this.enableTicketAssistant(issueKey);
                    });
                });
            }

            async disableTicketAssistant() {
                const issueKey = document.getElementById('ticketIssueKey').value.trim();
                const reason = document.getElementById('disableReason').value.trim();

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/disable`, {
                        method: 'POST',
                        body: JSON.stringify({ reason })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(`AI Assistant disabled for ticket ${issueKey}`, 'success');
                        this.addActivity(`AI Assistant disabled for ticket ${issueKey}`, 'success');
                        
                        // Clear form
                        document.getElementById('ticketIssueKey').value = '';
                        document.getElementById('disableReason').value = '';
                        
                        // Reload disabled tickets
                        await this.loadDisabledTickets();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error disabling ticket assistant:', error);
                    this.showStatus(`Error disabling assistant: ${error.message}`, 'error');
                }
            }

            async enableTicketAssistant(issueKey) {
                if (!issueKey) {
                    issueKey = document.getElementById('ticketIssueKey').value.trim();
                }

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/enable`, {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus(`AI Assistant enabled for ticket ${issueKey}`, 'success');
                        this.addActivity(`AI Assistant enabled for ticket ${issueKey}`, 'success');
                        
                        // Clear form if it was used
                        if (document.getElementById('ticketIssueKey').value === issueKey) {
                            document.getElementById('ticketIssueKey').value = '';
                            document.getElementById('disableReason').value = '';
                        }
                        
                        // Reload disabled tickets
                        await this.loadDisabledTickets();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error enabling ticket assistant:', error);
                    this.showStatus(`Error enabling assistant: ${error.message}`, 'error');
                }
            }

            async checkTicketStatus() {
                const issueKey = document.getElementById('ticketIssueKey').value.trim();

                if (!issueKey) {
                    this.showStatus('Please enter a ticket key', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/tickets/${issueKey}/status`);
                    if (!response) return;
                    const data = await response.json();
                    
                    if (data.success) {
                        const status = data.data.isDisabled ? 'DISABLED' : 'ENABLED';
                        const reason = data.data.ticketInfo?.reason || 'No reason provided';
                        const disabledAt = data.data.ticketInfo?.disabledAt ? 
                            new Date(data.data.ticketInfo.disabledAt).toLocaleString() : 'Unknown';
                        
                        let message = `Ticket ${issueKey} status: ${status}`;
                        if (data.data.isDisabled) {
                            message += `\nReason: ${reason}\nDisabled at: ${disabledAt}`;
                        }
                        
                        this.showStatus(message, data.data.isDisabled ? 'warning' : 'success');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error checking ticket status:', error);
                    this.showStatus(`Error checking status: ${error.message}`, 'error');
                }
            }

            // === WEBHOOK CONFIGURATION METHODS ===

            async saveWebhookConfiguration() {
                const webhookUrl = document.getElementById('webhookUrl').value.trim();
                const webhookAssistant = document.getElementById('webhookAssistant').value;

                if (!webhookUrl) {
                    this.showStatus('Please enter a webhook URL', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/configure', {
                        method: 'POST',
                        body: JSON.stringify({
                            webhookUrl: webhookUrl,
                            assistantId: webhookAssistant || null
                        })
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook configuration saved successfully', 'success');
                        this.addActivity('Webhook configuration updated', 'success');
                        this.updateWebhookStatus();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error saving webhook configuration:', error);
                    this.showStatus(`Error saving webhook: ${error.message}`, 'error');
                }
            }

            async testWebhook() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/test', {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook test successful', 'success');
                        this.addActivity('Webhook test completed successfully', 'success');
                        document.getElementById('webhookLastTest').textContent = new Date().toLocaleString();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error testing webhook:', error);
                    this.showStatus(`Webhook test failed: ${error.message}`, 'error');
                }
            }

            async disableWebhook() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/disable', {
                        method: 'POST'
                    });
                    if (!response) return;

                    const data = await response.json();
                    
                    if (data.success) {
                        this.showStatus('Webhook disabled successfully', 'success');
                        this.addActivity('Webhook disabled', 'warning');
                        this.updateWebhookStatus();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error disabling webhook:', error);
                    this.showStatus(`Error disabling webhook: ${error.message}`, 'error');
                }
            }

            // Webhook Filter Methods
            toggleWebhookFilterConfig() {
                const filterEnabled = document.getElementById('webhookFilterEnabled');
                const filterConfig = document.getElementById('webhookFilterConfig');
                const filterCondition = document.getElementById('webhookFilterCondition');
                const filterValue = document.getElementById('webhookFilterValue');
                
                if (filterEnabled && filterConfig) {
                    if (filterEnabled.checked) {
                        filterConfig.style.display = 'block';
                        // Los campos están deshabilitados por diseño - solo muestran información
                        if (filterCondition) filterCondition.disabled = true;
                        if (filterValue) filterValue.disabled = true;
                    } else {
                        filterConfig.style.display = 'none';
                    }
                }
            }

            async saveWebhookFilter() {
                try {
                    const filterEnabled = document.getElementById('webhookFilterEnabled').checked;
                    // Los valores están fijos por diseño - solo se puede habilitar/deshabilitar
                    const filterCondition = 'response_value';
                    const filterValue = 'Yes'; // Siempre "Yes" - solo envía webhook cuando Escalate agent dice "Yes"

                    const response = await this.authenticatedFetch('/api/admin/webhook/filter', {
                        method: 'POST',
                        body: JSON.stringify({
                            filterEnabled,
                            filterCondition,
                            filterValue
                        })
                    });
                    
                    if (!response) return;
                    const data = await response.json();
                    
                    if (data.success) {
                        const statusMessage = filterEnabled 
                            ? 'Webhook filter enabled - only sends webhook when Escalate agent determines human intervention is needed'
                            : 'Webhook filter disabled - all webhooks will be sent';
                        this.showStatus(statusMessage, 'success');
                        this.addActivity(`Webhook filter ${filterEnabled ? 'enabled' : 'disabled'}`, 'info');
                        this.updateWebhookStatus();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error saving webhook filter:', error);
                    this.showStatus(`Error saving webhook filter: ${error.message}`, 'error');
                }
            }

            async updateWebhookStatus() {
                try {
                    const response = await this.authenticatedFetch('/api/admin/webhook/status');
                    if (!response) return;
                    const data = await response.json();

                    if (data.success) {
                        const status = data.data.isEnabled ? 'Enabled' : 'Disabled';
                        const url = data.data.webhookUrl ? 'Configured' : 'Not configured';
                        const isJiraAutomation = data.data.webhookUrl?.includes('api-private.atlassian.com/automation/webhooks');
                        const webhookType = isJiraAutomation ? 'Jira Automation' : 'REST';
                        
                        document.getElementById('webhookStatus').textContent = `${status} - ${url}`;
                        document.getElementById('webhookType').textContent = webhookType;
                        document.getElementById('webhookUrl').value = data.data.webhookUrl || '';
                        
                        // Check token status (simplified check)
                        const hasToken = data.data.webhookUrl?.includes('api-private.atlassian.com');
                        document.getElementById('webhookTokenStatus').textContent = hasToken ? 'Required for Jira Automation' : 'Not required';
                        
                        // Update assistant dropdown only if it's empty or if we're explicitly updating webhook config
                        const webhookAssistantSelect = document.getElementById('webhookAssistant');
                        if (webhookAssistantSelect) {
                            // Only update if dropdown is empty or if we have a valid assistantId from webhook config
                            if (!webhookAssistantSelect.value || data.data.assistantId) {
                                webhookAssistantSelect.value = data.data.assistantId || '';
                            }
                        }
                        
                        // Update filter configuration
                        if (data.data.filter) {
                            const filterEnabled = document.getElementById('webhookFilterEnabled');
                            const filterConfig = document.getElementById('webhookFilterConfig');
                            const filterCondition = document.getElementById('webhookFilterCondition');
                            const filterValue = document.getElementById('webhookFilterValue');
                            
                            if (filterEnabled) {
                                filterEnabled.checked = data.data.filter.filterEnabled;
                                this.toggleWebhookFilterConfig();
                            }
                            
                            if (filterCondition) {
                                filterCondition.value = data.data.filter.filterCondition || 'response_value';
                            }
                            
                            if (filterValue) {
                                filterValue.value = data.data.filter.filterValue || 'Yes';
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating webhook status:', error);
                }
            }

            // === SAVED WEBHOOKS METHODS ===

            async loadSavedWebhooks() {
                try {
                    console.log('🔄 Loading saved webhooks...');
                    const response = await this.authenticatedFetch('/api/admin/webhooks/saved');
                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.populateSavedWebhooksDropdown(data.data);
                        console.log(`✅ Loaded ${data.data.length} saved webhooks`);
                    }
                } catch (error) {
                    console.error('Error loading saved webhooks:', error);
                }
            }

            populateSavedWebhooksDropdown(webhooks) {
                const select = document.getElementById('savedWebhookSelect');
                if (!select) return;

                // Clear existing options except the first one
                select.innerHTML = '<option value="">Choose a saved webhook...</option>';

                webhooks.forEach(webhook => {
                    const option = document.createElement('option');
                    option.value = webhook.id;
                    option.textContent = `${webhook.name} - ${webhook.url.substring(0, 50)}...`;
                    option.dataset.url = webhook.url;
                    option.dataset.name = webhook.name;
                    option.dataset.description = webhook.description || '';
                    select.appendChild(option);
                });
            }

            async saveWebhook() {
                try {
                    const name = document.getElementById('webhookName').value.trim();
                    const url = document.getElementById('webhookUrl').value.trim();
                    const description = document.getElementById('webhookDescription').value.trim();

                    if (!name || !url) {
                        this.showStatus('Name and URL are required', 'error');
                        return;
                    }

                    console.log('🔄 Saving webhook...');
                    const response = await this.authenticatedFetch('/api/admin/webhooks/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name, url, description })
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Webhook saved successfully', 'success');
                        this.addActivity(`Webhook "${name}" saved`, 'success');
                        await this.loadSavedWebhooks(); // Reload the dropdown
                        this.clearWebhookForm(); // Clear form after saving
                        this.hideNewWebhookFields(); // Hide the new webhook fields
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error saving webhook:', error);
                    this.showStatus(`Error saving webhook: ${error.message}`, 'error');
                }
            }

            async deleteSavedWebhook() {
                try {
                    const select = document.getElementById('savedWebhookSelect');
                    const selectedId = select.value;

                    if (!selectedId) {
                        this.showStatus('Please select a webhook to delete', 'error');
                        return;
                    }

                    if (!confirm('Are you sure you want to delete this saved webhook?')) {
                        return;
                    }

                    console.log('🔄 Deleting saved webhook...');
                    const response = await this.authenticatedFetch(`/api/admin/webhooks/${selectedId}`, {
                        method: 'DELETE'
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Webhook deleted successfully', 'success');
                        this.addActivity(`Webhook deleted`, 'warning');
                        await this.loadSavedWebhooks(); // Reload the dropdown
                        this.clearWebhookForm();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('Error deleting webhook:', error);
                    this.showStatus(`Error deleting webhook: ${error.message}`, 'error');
                }
            }

            clearWebhookForm() {
                document.getElementById('webhookUrl').value = '';
                document.getElementById('webhookName').value = '';
                document.getElementById('webhookDescription').value = '';
                document.getElementById('savedWebhookSelect').value = '';
                document.getElementById('deleteWebhookBtn').style.display = 'none';
            }

            showNewWebhookFields() {
                document.getElementById('newWebhookFields').style.display = 'block';
                document.getElementById('newWebhookDescription').style.display = 'block';
                document.getElementById('saveWebhookBtn').style.display = 'inline-block';
                document.getElementById('cancelNewWebhookBtn').style.display = 'inline-block';
                document.getElementById('createNewWebhookBtn').style.display = 'none';
            }

            hideNewWebhookFields() {
                document.getElementById('newWebhookFields').style.display = 'none';
                document.getElementById('newWebhookDescription').style.display = 'none';
                document.getElementById('saveWebhookBtn').style.display = 'none';
                document.getElementById('cancelNewWebhookBtn').style.display = 'none';
                document.getElementById('createNewWebhookBtn').style.display = 'inline-block';
            }

            // === USER MANAGEMENT METHODS ===

            async loadUserProfile() {
                try {
                    console.log('🔄 Cargando perfil de usuario...');
                    const response = await this.authenticatedFetch('/api/auth/profile');
                    if (!response) {
                        console.log('❌ No hay respuesta del servidor');
                        return;
                    }

                    const data = await response.json();
                    console.log('📊 Perfil de usuario recibido:', data);
                    
                    if (data.success && data.data.user) {
                        const user = data.data.user;
                        this.currentUser = user;
                        console.log('✅ Usuario actual cargado:', user);
                        
                        // Actualizar la información del usuario en el header
                        document.getElementById('userName').textContent = user.username;
                        document.getElementById('userRole').textContent = user.role;
                        document.getElementById('userRole').className = `user-role ${user.role}`;
                        
                        // Mostrar/ocultar elementos según el rol y permisos
                        const settingsBtn = document.getElementById('settingsBtn');
                        if (user.role === 'admin') {
                            console.log('👑 Usuario es admin, mostrando botón de ajustes y pestaña de gestión');
                            settingsBtn.style.display = 'flex';
                            document.getElementById('userManagementTabBtn').style.display = 'flex';
                            this.showAllDashboardSections();
                        } else {
                            console.log('👤 Usuario no es admin, aplicando restricciones de permisos');
                            settingsBtn.style.display = 'flex'; // Los usuarios también pueden cambiar contraseña
                            document.getElementById('userManagementTabBtn').style.display = 'none';
                            this.applyUserPermissions(user.permissions || {});
                        }
                    } else {
                        console.error('❌ Error en respuesta del perfil:', data);
                    }
                } catch (error) {
                    console.error('❌ Error cargando perfil de usuario:', error);
                }
            }

            // === PERMISSION MANAGEMENT ===

            showAllDashboardSections() {
                console.log('👑 Mostrando todas las secciones para admin');
                // Mostrar todas las secciones de navegación
                document.querySelectorAll('.service-nav-btn').forEach(btn => {
                    btn.style.display = 'flex';
                });
                
                // Mostrar todas las secciones de contenido
                document.querySelectorAll('.section-card').forEach(section => {
                    section.style.display = 'block';
                });
            }

            applyUserPermissions(permissions) {
                console.log('🔐 Aplicando permisos de usuario:', permissions);
                
                // Mapeo de permisos a secciones del dashboard
                const permissionSectionMap = {
                    serviceManagement: {
                        navBtn: 'ai-config',
                        sectionSelector: '.section-card:has(.section-header h2:contains("AI Assistant Configuration"))',
                        sectionTitle: 'AI Assistant Configuration'
                    },
                    automaticAIDisableRules: {
                        navBtn: 'auto-disable-rules',
                        sectionSelector: '.section-card:has(.section-header h2:contains("Automatic AI Disable Rules"))',
                        sectionTitle: 'Automatic AI Disable Rules'
                    },
                    webhookConfiguration: {
                        navBtn: 'webhook-integration',
                        sectionSelector: '.section-card:has(.section-header h2:contains("Webhook Configuration"))',
                        sectionTitle: 'Webhook Configuration'
                    },
                    ticketControl: {
                        navBtn: 'manual-ticket-control',
                        sectionSelector: '.section-card:has(.section-header h2:contains("Ticket Control"))',
                        sectionTitle: 'Ticket Control'
                    },
                    aiEnabledProjects: {
                        sectionSelector: '.section-card:has(.section-header h2:contains("AI Enabled Projects"))',
                        sectionTitle: 'AI Enabled Projects'
                    },
                    remoteServerIntegration: {
                        sectionSelector: '.section-card:has(.section-header h2:contains("Remote Server Integration"))',
                        sectionTitle: 'Remote Server Integration'
                    }
                };

                // Ocultar todas las secciones de navegación primero
                Object.values(permissionSectionMap).forEach(mapping => {
                    if (mapping.navBtn) {
                        const navBtn = document.querySelector(`[data-service="${mapping.navBtn}"]`);
                        if (navBtn) {
                            navBtn.style.display = 'none';
                        }
                    }
                });

                // Ocultar todas las secciones de contenido primero
                document.querySelectorAll('.section-card').forEach(section => {
                    const header = section.querySelector('.section-header h2');
                    if (header) {
                        const sectionTitle = header.textContent.trim();
                        // Verificar si esta sección está mapeada a algún permiso
                        const isMappedSection = Object.values(permissionSectionMap).some(mapping => 
                            mapping.sectionTitle === sectionTitle
                        );
                        if (isMappedSection) {
                            section.style.display = 'none';
                        }
                    }
                });

                // Mostrar solo las secciones permitidas
                Object.entries(permissions).forEach(([permission, hasAccess]) => {
                    if (hasAccess && permissionSectionMap[permission]) {
                        const mapping = permissionSectionMap[permission];
                        
                        // Mostrar botón de navegación si existe
                        if (mapping.navBtn) {
                            const navBtn = document.querySelector(`[data-service="${mapping.navBtn}"]`);
                            if (navBtn) {
                                navBtn.style.display = 'flex';
                                console.log(`✅ Mostrando botón de navegación: ${mapping.navBtn}`);
                            }
                        }
                        
                        // Mostrar sección de contenido
                        if (mapping.sectionTitle) {
                            const sections = document.querySelectorAll('.section-card');
                            sections.forEach(section => {
                                const header = section.querySelector('.section-header h2');
                                if (header && header.textContent.trim() === mapping.sectionTitle) {
                                    section.style.display = 'block';
                                    console.log(`✅ Mostrando sección: ${mapping.sectionTitle}`);
                                }
                            });
                        }
                    }
                });

                // Overview siempre visible
                const overviewBtn = document.querySelector('[data-service="overview"]');
                if (overviewBtn) {
                    overviewBtn.style.display = 'flex';
                }

                // Si no hay permisos, mostrar mensaje informativo
                const hasAnyPermission = Object.values(permissions).some(p => p === true);
                if (!hasAnyPermission) {
                    this.showNoPermissionsMessage();
                } else {
                    this.hideNoPermissionsMessage();
                }
            }

            showNoPermissionsMessage() {
                // Crear mensaje si no existe
                let message = document.getElementById('noPermissionsMessage');
                if (!message) {
                    message = document.createElement('div');
                    message.id = 'noPermissionsMessage';
                    message.className = 'alert alert-warning';
                    message.style.cssText = 'margin: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;';
                    message.innerHTML = `
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Acceso Restringido</strong><br>
                        No tienes permisos para acceder a las funcionalidades del dashboard. 
                        Contacta a un administrador para solicitar los permisos necesarios.
                    `;
                    
                    // Insertar después de la navegación
                    const serviceNav = document.querySelector('.service-nav');
                    if (serviceNav && serviceNav.nextSibling) {
                        serviceNav.parentNode.insertBefore(message, serviceNav.nextSibling);
                    }
                }
                message.style.display = 'block';
            }

            hideNoPermissionsMessage() {
                const message = document.getElementById('noPermissionsMessage');
                if (message) {
                    message.style.display = 'none';
                }
            }

            // === MODAL MANAGEMENT ===

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden';
                }
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    document.body.style.overflow = 'auto';
                }
            }

            showSettingsTab(tabName) {
                console.log('🔄 Cambiando a pestaña:', tabName);
                
                // Ocultar todas las pestañas
                document.querySelectorAll('.settings-tab-content').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                // Remover clase active de todos los botones
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Mostrar pestaña seleccionada
                const tabContent = document.getElementById(tabName + 'Tab');
                const tabBtn = document.getElementById(tabName + 'TabBtn');
                
                if (tabContent) {
                    tabContent.style.display = 'block';
                    console.log('✅ Pestaña mostrada:', tabName);
                }
                if (tabBtn) {
                    tabBtn.classList.add('active');
                    console.log('✅ Botón activado:', tabName);
                }
                
                // Cargar usuarios si es la pestaña de gestión
                if (tabName === 'userManagement') {
                    console.log('🔄 Cargando usuarios para pestaña de gestión...');
                    this.loadUsers();
                }
            }

            // === PASSWORD MANAGEMENT ===

            async savePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!currentPassword || !newPassword || !confirmPassword) {
                    this.showStatus('Por favor completa todos los campos', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    this.showStatus('Las contraseñas no coinciden', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    this.showStatus('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch('/api/auth/change-password', {
                        method: 'PUT',
                        body: JSON.stringify({
                            currentPassword,
                            newPassword
                        })
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Contraseña actualizada exitosamente', 'success');
                        document.getElementById('changePasswordForm').reset();
                        this.closeModal('settingsModal');
                    } else {
                        this.showStatus(data.error || 'Error al cambiar la contraseña', 'error');
                    }
                } catch (error) {
                    console.error('Error cambiando contraseña:', error);
                    this.showStatus('Error al cambiar la contraseña', 'error');
                }
            }

            // === USER MANAGEMENT (ADMIN ONLY) ===

            async loadUsers() {
                try {
                    console.log('🔄 Cargando usuarios...');
                    console.log('🔑 Token de autenticación:', this.authToken ? 'Presente' : 'Ausente');
                    
                    // Test directo del endpoint
                    console.log('🧪 Haciendo petición directa a /api/admin/users...');
                    const response = await this.authenticatedFetch('/api/admin/users');
                    
                    console.log('📡 Respuesta recibida:', response);
                    console.log('📊 Status de respuesta:', response?.status);
                    console.log('📊 Headers de respuesta:', response?.headers);
                    
                    if (!response) {
                        throw new Error('No se pudo conectar con el servidor');
                    }

                    const data = await response.json();
                    console.log('📊 Respuesta de usuarios:', data);
                    
                    if (data.success && data.data && data.data.users) {
                        console.log('✅ Usuarios cargados:', data.data.users.length);
                        this.renderUsersTable(data.data.users);
                    } else {
                        console.error('❌ Error en respuesta:', data);
                        document.getElementById('usersList').innerHTML = '<p>Error: ' + (data.error || 'Respuesta inválida del servidor') + '</p>';
                    }
                } catch (error) {
                    console.error('❌ Error cargando usuarios:', error);
                    console.error('❌ Stack trace:', error.stack);
                    document.getElementById('usersList').innerHTML = '<p>Error al cargar usuarios: ' + error.message + '</p>';
                }
            }

            renderUsersTable(users) {
                const usersList = document.getElementById('usersList');
                console.log('🔄 Renderizando tabla de usuarios:', users);
                
                if (!users || users.length === 0) {
                    usersList.innerHTML = '<p>No hay usuarios registrados</p>';
                    return;
                }

                const tableHTML = `
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Estado</th>
                                <th>Último Login</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(user => `
                                <tr>
                                    <td>${user.username}</td>
                                    <td>${user.email}</td>
                                    <td><span class="role-badge role-${user.role}">${user.role}</span></td>
                                    <td><span class="status-badge status-${user.isActive ? 'active' : 'inactive'}">${user.isActive ? 'Activo' : 'Inactivo'}</span></td>
                                    <td>${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Nunca'}</td>
                                    <td class="user-actions">
                                        <button class="btn btn-sm btn-primary edit-user-btn" data-user-id="${user.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary change-password-btn" data-user-id="${user.id}">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        ${user.role === 'user' ? `
                                            <button class="btn btn-sm btn-warning permissions-btn" data-user-id="${user.id}" data-username="${user.username}" title="Gestionar Permisos">
                                                <i class="fas fa-shield-alt"></i>
                                            </button>
                                        ` : ''}
                                        ${user.id !== this.currentUser.id ? `
                                            <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                
                usersList.innerHTML = tableHTML;
                console.log('✅ Tabla de usuarios renderizada');
                
                // Agregar event listeners a los botones de la tabla
                this.setupUserTableEventListeners();
            }

            setupUserTableEventListeners() {
                console.log('🔄 Configurando event listeners de la tabla de usuarios...');
                
                // Event listeners para botones de editar usuario
                const editButtons = document.querySelectorAll('.edit-user-btn');
                console.log('📝 Botones de editar encontrados:', editButtons.length);
                editButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = parseInt(e.currentTarget.dataset.userId);
                        console.log('🔄 Editando usuario ID:', userId);
                        this.editUser(userId);
                    });
                });
                
                // Event listeners para botones de cambiar contraseña
                const passwordButtons = document.querySelectorAll('.change-password-btn');
                console.log('🔑 Botones de cambiar contraseña encontrados:', passwordButtons.length);
                passwordButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = parseInt(e.currentTarget.dataset.userId);
                        console.log('🔄 Cambiando contraseña de usuario ID:', userId);
                        this.changeUserPasswordModal(userId);
                    });
                });
                
                // Event listeners para botones de permisos
                const permissionsButtons = document.querySelectorAll('.permissions-btn');
                console.log('🛡️ Botones de permisos encontrados:', permissionsButtons.length);
                permissionsButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = parseInt(e.currentTarget.dataset.userId);
                        const username = e.currentTarget.dataset.username;
                        console.log('🔄 Gestionando permisos de usuario ID:', userId, 'Username:', username);
                        this.showUserPermissionsModal(userId, username);
                    });
                });
                
                // Event listeners para botones de eliminar usuario
                const deleteButtons = document.querySelectorAll('.delete-user-btn');
                console.log('🗑️ Botones de eliminar encontrados:', deleteButtons.length);
                deleteButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = parseInt(e.currentTarget.dataset.userId);
                        console.log('🔄 Eliminando usuario ID:', userId);
                        this.deleteUser(userId);
                    });
                });
                
                console.log('✅ Event listeners configurados');
            }

            showCreateUserModal() {
                document.getElementById('createUserForm').reset();
                this.openModal('createUserModal');
            }

            async createUser() {
                const username = document.getElementById('newUsername').value;
                const email = document.getElementById('newUserEmail').value;
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;

                if (!username || !email || !password) {
                    this.showStatus('Por favor completa todos los campos', 'error');
                    return;
                }

                if (password.length < 6) {
                    this.showStatus('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }

                // Mostrar indicador de carga
                const createBtn = document.getElementById('confirmCreateUserBtn');
                const originalText = createBtn.innerHTML;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creando...';
                createBtn.disabled = true;

                try {
                    const response = await this.authenticatedFetch('/api/admin/users', {
                        method: 'POST',
                        body: JSON.stringify({
                            username,
                            email,
                            password,
                            role
                        })
                    });

                    if (!response) {
                        throw new Error('No se pudo conectar con el servidor');
                    }

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Usuario creado exitosamente', 'success');
                        this.closeModal('createUserModal');
                        // Recargar la lista de usuarios
                        await this.loadUsers();
                    } else {
                        this.showStatus(data.error || 'Error al crear usuario', 'error');
                    }
                } catch (error) {
                    console.error('Error creando usuario:', error);
                    this.showStatus('Error al crear usuario: ' + error.message, 'error');
                } finally {
                    // Restaurar botón
                    createBtn.innerHTML = originalText;
                    createBtn.disabled = false;
                }
            }

            async editUser(userId) {
                try {
                    const response = await this.authenticatedFetch('/api/admin/users');
                    if (!response) return;

                    const data = await response.json();
                    if (data.success && data.data.users) {
                        const user = data.data.users.find(u => u.id === userId);
                        if (user) {
                            document.getElementById('editUserId').value = user.id;
                            document.getElementById('editUsername').value = user.username;
                            document.getElementById('editUserEmail').value = user.email;
                            document.getElementById('editUserRole').value = user.role;
                            document.getElementById('editUserStatus').value = user.isActive.toString();
                            
                            this.openModal('editUserModal');
                        }
                    }
                } catch (error) {
                    console.error('Error cargando usuario:', error);
                    this.showStatus('Error al cargar usuario', 'error');
                }
            }

            async updateUser() {
                const userId = document.getElementById('editUserId').value;
                const username = document.getElementById('editUsername').value;
                const email = document.getElementById('editUserEmail').value;
                const role = document.getElementById('editUserRole').value;
                const isActive = document.getElementById('editUserStatus').value === 'true';

                if (!username || !email) {
                    this.showStatus('Por favor completa todos los campos', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            username,
                            email,
                            role,
                            isActive
                        })
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Usuario actualizado exitosamente', 'success');
                        this.closeModal('editUserModal');
                        this.loadUsers();
                    } else {
                        this.showStatus(data.error || 'Error al actualizar usuario', 'error');
                    }
                } catch (error) {
                    console.error('Error actualizando usuario:', error);
                    this.showStatus('Error al actualizar usuario', 'error');
                }
            }

            changeUserPasswordModal(userId) {
                document.getElementById('changePasswordUserId').value = userId;
                document.getElementById('changeUserPasswordForm').reset();
                this.openModal('changeUserPasswordModal');
            }

            async changeUserPassword() {
                const userId = document.getElementById('changePasswordUserId').value;
                const newPassword = document.getElementById('newUserPasswordInput').value;
                const confirmPassword = document.getElementById('confirmNewUserPassword').value;

                if (!newPassword || !confirmPassword) {
                    this.showStatus('Por favor completa todos los campos', 'error');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    this.showStatus('Las contraseñas no coinciden', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    this.showStatus('La contraseña debe tener al menos 6 caracteres', 'error');
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/users/${userId}/password`, {
                        method: 'PUT',
                        body: JSON.stringify({
                            newPassword
                        })
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Contraseña actualizada exitosamente', 'success');
                        this.closeModal('changeUserPasswordModal');
                    } else {
                        this.showStatus(data.error || 'Error al cambiar contraseña', 'error');
                    }
                } catch (error) {
                    console.error('Error cambiando contraseña:', error);
                    this.showStatus('Error al cambiar contraseña', 'error');
                }
            }

            async deleteUser(userId) {
                if (!confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                    return;
                }

                try {
                    const response = await this.authenticatedFetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE'
                    });

                    if (!response) return;

                    const data = await response.json();
                    if (data.success) {
                        this.showStatus('Usuario eliminado exitosamente', 'success');
                        this.loadUsers();
                    } else {
                        this.showStatus(data.error || 'Error al eliminar usuario', 'error');
                    }
                } catch (error) {
                    console.error('Error eliminando usuario:', error);
                    this.showStatus('Error al eliminar usuario', 'error');
                }
            }

            // === SERVICE NAVIGATION METHODS ===

            setupServiceNavigation() {
                const navButtons = document.querySelectorAll('.service-nav-btn');
                navButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const service = e.currentTarget.dataset.service;
                        this.showService(service);
                    });
                });
            }

            showService(serviceName) {
                console.log(`🔄 Switching to service: ${serviceName}`);
                
                // Update navigation buttons
                const navButtons = document.querySelectorAll('.service-nav-btn');
                navButtons.forEach(button => {
                    button.classList.remove('active');
                    if (button.dataset.service === serviceName) {
                        button.classList.add('active');
                    }
                });

                // Scroll to the appropriate section
                this.scrollToService(serviceName);
            }

            scrollToService(serviceName) {
                let targetElement = null;
                
                switch(serviceName) {
                    case 'dashboard':
                        targetElement = document.querySelector('.stats-section');
                        break;
                    case 'ai-config':
                        targetElement = document.querySelector('.global-assistant-info');
                        break;
                    case 'webhook-integration':
                        targetElement = document.querySelector('.webhook-section');
                        break;
                    case 'auto-disable-rules':
                        targetElement = document.querySelector('.status-control-section');
                        break;
                    case 'manual-ticket-control':
                        targetElement = document.querySelector('.ticket-control-section');
                        break;
                }

                if (targetElement) {
                    targetElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start',
                        inline: 'nearest'
                    });
                    console.log(`✅ Scrolled to ${serviceName} section`);
                } else {
                    console.log(`⚠️ Section not found for service: ${serviceName}`);
                }
            }

            // === STATUS-BASED DISABLE METHODS ===

            async loadStatusDisableConfig() {
                try {
                    console.log('🔄 Loading status disable configuration...');
                    
                    // Load current configuration
                    const configResponse = await this.authenticatedFetch('/api/admin/status-disable/config');
                    if (!configResponse) {
                        console.error('❌ No config response received');
                        return;
                    }
                    const configData = await configResponse.json();
                    console.log('📊 Config data:', configData);

                    // Load available statuses
                    const statusesResponse = await this.authenticatedFetch('/api/admin/statuses/available');
                    if (!statusesResponse) {
                        console.error('❌ No statuses response received');
                        return;
                    }
                    const statusesData = await statusesResponse.json();
                    console.log('📋 Statuses data:', statusesData);

                    if (configData.success && statusesData.success) {
                        console.log('✅ Both requests successful, populating UI...');
                        this.populateStatusCheckboxes(statusesData.data);
                        this.updateStatusDisableUI(configData.data);
                    } else {
                        console.error('❌ One or both requests failed:', {
                            configSuccess: configData.success,
                            statusesSuccess: statusesData.success
                        });
                    }
                } catch (error) {
                    console.error('❌ Error loading status disable config:', error);
                }
            }

            populateStatusCheckboxes(statuses) {
                console.log('📋 Populating status checkboxes with:', statuses);
                
                const container = document.getElementById('statusCheckboxes');
                if (!container) {
                    console.error('❌ statusCheckboxes container not found');
                    return;
                }
                
                container.innerHTML = '';

                statuses.forEach(status => {
                    console.log('🔲 Creating checkbox for status:', status);
                    
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'status-checkbox-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `status_${status.id}`;
                    checkbox.value = status.name;
                    checkbox.className = 'status-checkbox';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `status_${status.id}`;
                    label.textContent = status.name;
                    label.className = 'status-label';
                    
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(label);
                    container.appendChild(checkboxContainer);
                });
                
                console.log(`✅ Created ${statuses.length} status checkboxes`);
            }

            updateStatusDisableUI(config) {
                console.log('🔄 Updating status disable UI with config:', config);
                
                const enabledCheckbox = document.getElementById('statusDisableEnabled');
                const statusSelectionGroup = document.getElementById('statusSelectionGroup');
                const statusDisableStatus = document.getElementById('statusDisableStatus');
                const triggerStatusesList = document.getElementById('triggerStatusesList');

                if (!enabledCheckbox || !statusSelectionGroup || !statusDisableStatus || !triggerStatusesList) {
                    console.error('❌ One or more UI elements not found');
                    return;
                }

                enabledCheckbox.checked = config.isEnabled;
                statusSelectionGroup.style.display = config.isEnabled ? 'block' : 'none';
                
                statusDisableStatus.textContent = config.isEnabled ? 'Enabled' : 'Disabled';
                triggerStatusesList.textContent = config.triggerStatuses.length > 0 
                    ? config.triggerStatuses.join(', ') 
                    : 'None';

                console.log('🔲 Checking status checkboxes for:', config.triggerStatuses);
                // Check the appropriate status checkboxes
                config.triggerStatuses.forEach(statusName => {
                    const checkbox = document.querySelector(`input[value="${statusName}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log(`✅ Checked checkbox for status: ${statusName}`);
                    } else {
                        console.log(`❌ Checkbox not found for status: ${statusName}`);
                    }
                });
                
                console.log('✅ Status disable UI updated');
            }

            // === USER PERMISSIONS MANAGEMENT ===

            async showUserPermissionsModal(userId, username) {
                try {
                    console.log('🛡️ Loading permissions for user:', userId, username);
                    
                    // Set user info in modal
                    document.getElementById('permissionsUserId').value = userId;
                    document.getElementById('permissionsUserName').textContent = username;
                    
                    // Load current permissions
                    const response = await this.authenticatedFetch(`/api/admin/users/${userId}/permissions`);
                    if (!response) return;
                    
                    const data = await response.json();
                    if (data.success) {
                        const permissions = data.data.permissions;
                        console.log('✅ Permissions loaded:', permissions);
                        
                        // Set checkbox states
                        Object.keys(permissions).forEach(permission => {
                            const checkbox = document.getElementById(`perm_${permission}`);
                            if (checkbox) {
                                checkbox.checked = permissions[permission];
                            }
                        });
                        
                        this.openModal('userPermissionsModal');
                    } else {
                        this.showStatus(data.error || 'Error loading permissions', 'error');
                    }
                } catch (error) {
                    console.error('❌ Error loading user permissions:', error);
                    this.showStatus('Error loading user permissions', 'error');
                }
            }

            async saveUserPermissions() {
                try {
                    const userId = document.getElementById('permissionsUserId').value;
                    const username = document.getElementById('permissionsUserName').textContent;
                    
                    console.log('🛡️ Saving permissions for user:', userId, username);
                    
                    // Collect permission states
                    const permissions = {
                        serviceManagement: document.getElementById('perm_serviceManagement').checked,
                        automaticAIDisableRules: document.getElementById('perm_automaticAIDisableRules').checked,
                        webhookConfiguration: document.getElementById('perm_webhookConfiguration').checked,
                        ticketControl: document.getElementById('perm_ticketControl').checked,
                        aiEnabledProjects: document.getElementById('perm_aiEnabledProjects').checked,
                        remoteServerIntegration: document.getElementById('perm_remoteServerIntegration').checked
                    };
                    
                    console.log('📊 Permissions to save:', permissions);
                    
                    const response = await this.authenticatedFetch(`/api/admin/users/${userId}/permissions`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ permissions })
                    });
                    
                    if (!response) return;
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('✅ Permissions saved successfully');
                        this.showStatus(`Permisos actualizados para ${username}`, 'success');
                        this.closeModal('userPermissionsModal');
                        
                        // Refresh users table to show updated info
                        this.loadUsers();
                    } else {
                        this.showStatus(data.error || 'Error saving permissions', 'error');
                    }
                } catch (error) {
                    console.error('❌ Error saving user permissions:', error);
                    this.showStatus('Error saving user permissions', 'error');
                }
            }

            async saveStatusDisableConfig() {
                console.log('🔧 Saving status disable configuration...');
                
                const isEnabled = document.getElementById('statusDisableEnabled').checked;
                const selectedStatuses = Array.from(document.querySelectorAll('.status-checkbox:checked'))
                    .map(checkbox => checkbox.value);

                console.log('📊 Configuration data:', {
                    isEnabled,
                    selectedStatuses,
                    totalCheckboxes: document.querySelectorAll('.status-checkbox').length,
                    checkedCheckboxes: document.querySelectorAll('.status-checkbox:checked').length
                });

                try {
                    const response = await this.authenticatedFetch('/api/admin/status-disable/configure', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isEnabled: isEnabled,
                            triggerStatuses: selectedStatuses
                        })
                    });
                    
                    console.log('📡 Response received:', response);
                    if (!response) {
                        console.error('❌ No response received');
                        return;
                    }

                    const data = await response.json();
                    console.log('📊 Response data:', data);
                    
                    if (data.success) {
                        console.log('✅ Configuration saved successfully');
                        this.showStatus('Status-based disable configuration saved successfully', 'success');
                        this.addActivity('Status-based disable configuration updated', 'success');
                        this.updateStatusDisableUI(data.data);
                    } else {
                        console.error('❌ Configuration save failed:', data.error);
                        throw new Error(data.error);
                    }
                } catch (error) {
                    console.error('❌ Error saving status disable configuration:', error);
                    this.showStatus(`Error saving configuration: ${error.message}`, 'error');
                }
            }
        }

                 // Variable global para el dashboard
         let dashboard;
 

         // Inicializar cuando el DOM esté listo
         document.addEventListener('DOMContentLoaded', function() {
             dashboard = new CEODashboard();
             
             // Event listener para el botón de ajustes
             document.getElementById('settingsBtn').addEventListener('click', function() {
                 dashboard.openModal('settingsModal');
             });
             
             // Event listener para el checkbox de status disable
             document.getElementById('statusDisableEnabled').addEventListener('change', function() {
                 const statusSelectionGroup = document.getElementById('statusSelectionGroup');
                 statusSelectionGroup.style.display = this.checked ? 'block' : 'none';
             });
             
             // Event listeners para los botones de status disable
             document.getElementById('saveStatusDisableBtn').addEventListener('click', function() {
                 if (dashboard) {
                     dashboard.saveStatusDisableConfig();
                 }
             });
             
             document.getElementById('loadStatusDisableBtn').addEventListener('click', function() {
                 if (dashboard) {
                     dashboard.loadStatusDisableConfig();
                 }
             });
         });

         // Las funciones globales han sido reemplazadas por event listeners
    </script>
</body>
</html>